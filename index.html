<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nh·∫≠p H√†ng - C√¥ M·∫≠p Fashion</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#f5d7fa" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: linear-gradient(to right, #fdfbfb, #ebedee);
      max-width: 600px;
      margin: 0 auto;
    }
    h2 {
      color: #d147a3;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background: #d147a3;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    #preview {
      margin-top: 20px;
      border: 1px solid #ddd;
      padding: 15px;
      display: none;
      background: white;
      border-radius: 8px;
    }
    iframe {
      width: 100%;
      height: 800px;
      border: 1px solid #eee;
      margin-top: 10px;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .action-buttons button {
      flex: 1;
      padding: 10px;
      border-radius: 6px;
    }
    .print-button { background: #4CAF50 !important; }
    .pdf-button { background: #2196F3 !important; }

    /* In ƒë·∫πp h∆°n */
    @media print {
      @page {
        size: 280px 176px;
        margin: 0;
      }
      body * {
        visibility: hidden;
      }
      #htmlPreview, #htmlPreview * {
        visibility: visible;
      }
      #htmlPreview {
        position: absolute;
        left: 0;
        top: 0;
        width: 280px;
        height: 176px;
        transform: scale(1);
        transform-origin: top left;
      }
      iframe {
        height: 176px !important;
      }
    }
  </style>
</head>
<body>
  <h2>‚úÖ Nh·∫≠p h√†ng m·ªõi ‚Äì C√¥ M·∫≠p Fashion</h2>
  <input type="text" id="sku" placeholder="SKU (V√≠ d·ª•: A350)" value="A350" />
  <input type="text" id="size" placeholder="Size (V√≠ d·ª•: XL)" value="XL" />
  <input type="number" id="qty" placeholder="S·ªë l∆∞·ª£ng" value="15" min="1" />
  <input type="text" id="staff" placeholder="Nh√¢n vi√™n" value="Linh" />
  <button onclick="submitImport()">üì§ G·ª≠i nh·∫≠p h√†ng</button>

  <div id="preview">
    <h3>üìé Xem tr∆∞·ªõc QR:</h3>
    <div class="action-buttons">
      <button class="print-button" onclick="printQR()">üñ®Ô∏è In QR</button>
      <button class="pdf-button" onclick="downloadPDF()">üíæ T·∫£i PDF</button>
    </div>
    <iframe id="htmlPreview"></iframe>
  </div>

  <script>
    async function submitImport() {
      const sku = document.getElementById("sku").value.trim();
      const size = document.getElementById("size").value.trim();
      const qty = parseInt(document.getElementById("qty").value);
      const staff = document.getElementById("staff").value.trim();

      if (!sku || !size || !qty || !staff) {
        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
      }

      const payload = { sku, size, qty, staff };

      try {
        const res = await fetch("https://n8n-hongnhung198198-u40833.vm.elestio.app/webhook/import-items", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        let data;
        try {
          data = await res.json();
        } catch (e) {
          throw new Error(`Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON: ${await res.text().then(t => t.substring(0, 200))}`);
        }

        console.log("Data received:", data);

        let htmlUrl;
        if (Array.isArray(data)) {
          if (data.length > 0 && data[0] && data[0].url) {
            htmlUrl = data[0].url;
          }
        } else if (typeof data === 'object' && data !== null && data.url) {
          htmlUrl = data.url;
        }

        if (!htmlUrl) {
          throw new Error("Ph·∫£n h·ªìi kh√¥ng ch·ª©a URL h·ª£p l·ªá");
        }

        if (!htmlUrl.startsWith("data:text/html;base64,")) {
          throw new Error("URL kh√¥ng ph·∫£i d·ªØ li·ªáu base64 HTML");
        }

        const base64Html = htmlUrl.split(",")[1];
        if (!base64Html) {
          throw new Error("Kh√¥ng th·ªÉ tr√≠ch xu·∫•t base64");
        }

        const htmlContent = atob(base64Html);
        const blob = new Blob([htmlContent], { type: "text/html" });
        const url = URL.createObjectURL(blob);

        document.getElementById("preview").style.display = "block";
        document.getElementById("htmlPreview").src = url;

      } catch (err) {
        console.error("L·ªói khi g·ªçi webhook:", err);
        alert(`‚ùå L·ªói: ${err.message}`);
      }
    }

    function printQR() {
      const iframe = document.getElementById("htmlPreview");
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
      } else {
        alert("Kh√¥ng th·ªÉ in. Vui l√≤ng th·ª≠ l·∫°i sau khi t·∫£i xong.");
      }
    }

    function downloadPDF() {
      const iframe = document.getElementById("htmlPreview");
      if (!iframe || !iframe.contentWindow || !iframe.contentDocument) {
        alert("Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ t·∫£i. Vui l√≤ng ch·ªù t·∫£i xong.");
        return;
      }

      const htmlContent = iframe.contentDocument.documentElement.outerHTML;
      const blob = new Blob([htmlContent], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      const win = window.open(url, '_blank');
      if (win) {
        win.onload = () => {
          win.focus();
          // G·ª£i √Ω in ‚Üí l∆∞u PDF
          setTimeout(() => win.print(), 500);
        };
      } else {
        alert("Vui l√≤ng cho ph√©p pop-up ƒë·ªÉ t·∫£i PDF.");
      }
    }

    // ƒêƒÉng k√Ω Service Worker (n·∫øu c√≥)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(console.warn);
      });
    }
  </script>
</body>
</html>