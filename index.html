<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>In tem - Cô Mập Fashion</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --surface: #f4f5f7;
      --surface-tonal: #ffffff;
      --text: #1b1d23;
      --text-muted: #5e6270;
      --border: #e2e5ec;
      --accent: #1d4ed8;
      --danger: #c0392b;
      --success: #0f7b3a;
      --radius: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--surface);
      color: var(--text);
      padding: 32px clamp(16px, 3vw, 48px);
    }

    h1,
    h2,
    h3 {
      margin: 0;
      font-weight: 600;
      color: var(--text);
    }

    p {
      margin: 0;
      color: var(--text-muted);
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .card {
      background: var(--surface-tonal);
      border-radius: var(--radius);
      padding: 24px;
      border: 1px solid var(--border);
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .page-header h1 {
      font-size: clamp(1.6rem, 3vw, 2.2rem);
      font-weight: 600;
    }

    .page-header p {
      margin: 4px 0 0;
      color: var(--text-muted);
    }

    .tab-nav {
      margin-top: 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #f8fafc;
      border-radius: 999px;
      padding: 4px;
      border: 1px solid var(--border);
      width: fit-content;
    }

    .tab-button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 0.95rem;
      font-weight: 600;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }

    .tab-nav .tab-button {
      width: auto;
      justify-content: center;
    }

    .tab-button[aria-selected="true"] {
      background: #fff;
      color: var(--text);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.12);
    }

    .tab-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .tab-panel[hidden] {
      display: none;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-muted);
      display: block;
      margin-bottom: 6px;
    }

    input,
    select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 14px 16px;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s ease, background 0.2s ease;
      background-color: #fff;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      background-color: #fefefe;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    th,
    td {
      padding: 14px 12px;
      border-bottom: 1px solid rgba(29, 27, 32, 0.07);
      text-align: left;
    }

    th {
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      text-transform: uppercase;
      background: rgba(103, 80, 164, 0.08);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr.has-error {
      background: rgba(220, 38, 38, 0.05);
    }

    .table-wrapper {
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      background: #fff;
    }

    .empty-state {
      text-align: center;
      padding: 28px;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .actions.single-action {
      justify-content: flex-end;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(29, 78, 216, 0.08);
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    button {
      font-family: inherit;
      border: none;
      border-radius: 999px;
      padding: 12px 22px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, opacity 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-outline {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .status-line {
      margin-top: 12px;
      font-size: 0.9rem;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
    }

    .status-line.success {
      background: rgba(15, 123, 58, 0.08);
      border-color: rgba(15, 123, 58, 0.25);
      color: var(--success);
    }

    .status-line.error {
      background: rgba(192, 57, 43, 0.08);
      border-color: rgba(192, 57, 43, 0.3);
      color: var(--danger);
    }

    .table-summary {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      font-size: 0.9rem;
      margin-bottom: 10px;
      color: var(--text-muted);
    }

    .layout-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .layout-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .hasize-form {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }

    .hasize-form > div {
      flex: 1;
      min-width: 220px;
    }

    .hasize-form button {
      flex: 0 0 auto;
      padding-inline: 28px;
    }

    .hasize-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .hasize-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      gap: 16px;
      background: #fff;
    }

    .hasize-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .hasize-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .hasize-meta span {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(29, 78, 216, 0.08);
    }

    .hasize-serial {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .hasize-info {
      list-style: none;
      padding: 0;
      margin: 0;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .hasize-info li + li {
      margin-top: 4px;
    }

    .hasize-qr {
      width: 140px;
      min-width: 140px;
      border-left: 1px dashed rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding-left: 12px;
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .hasize-qr img {
      width: 110px;
      height: 110px;
      object-fit: contain;
    }

    .hasize-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }


    .label-page {
      width: 105mm;
      max-width: 100%;
      height: 22mm;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      display: flex;
      overflow: hidden;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.25);
      position: relative;
    }

    .label-page::after {
      content: attr(data-page);
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 0.65rem;
      color: var(--text-muted);
    }

    .label-cell {
      flex: 1;
      min-width: 35mm;
      max-width: calc(100% / 3);
      border-right: 1px dashed rgba(15, 23, 42, 0.15);
      display: flex;
      gap: 6px;
      padding: 2mm 2mm 2mm 2.5mm;
      align-items: center;
      height: 22mm;
    }

    .label-cell:last-child {
      border-right: none;
    }

    .label-cell.is-blank {
      background: repeating-linear-gradient(45deg, #f1f5f9 0, #f1f5f9 6px, #fff 6px, #fff 12px);
      justify-content: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .label-qr {
      width: 20mm;
      min-width: 20mm;
      height: 22mm;
      display: grid;
      place-items: center;
      background: #fff;
      border-right: 1px solid rgba(15, 23, 42, 0.08);
      position: relative;
      padding: 0;
    }

    .label-qr img {
      width: 20mm;
      height: 20mm;
      object-fit: contain;
    }

    .label-qr .qr-fallback {
      position: absolute;
      inset: 0;
      display: none;
      font-size: 0.65rem;
      color: var(--danger);
      text-align: center;
      line-height: 22mm;
      background: repeating-linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0 6px, rgba(255, 255, 255, 0.5) 6px 12px);
    }

    .label-qr.qr-missing .qr-fallback {
      display: block;
    }

    .label-text {
      display: flex;
      flex-direction: column;
      justify-content: center;
      line-height: 1.25;
      font-size: 0.78rem;
      width: 15mm;
      height: 22mm;
    }

    .label-text .code {
      font-weight: 700;
      font-size: 0.9rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .label-text .size {
      text-transform: uppercase;
      font-weight: 600;
      font-size: 0.78rem;
    }

    #printArea {
      display: none;
    }

    .print-guide ul {
      margin: 12px 0 0 16px;
      color: var(--text-muted);
      font-size: 0.9rem;
      padding-left: 16px;
    }

    .print-guide li + li {
      margin-top: 6px;
    }

    @media (max-width: 720px) {
      body {
        padding: 16px;
      }

      .actions {
        flex-direction: column;
      }

      button {
        width: 100%;
        justify-content: center;
      }

      .label-page {
        width: 100%;
      }

      .hasize-card {
        flex-direction: column;
      }

      .hasize-qr {
        width: 100%;
        min-width: 0;
        border-left: none;
        border-top: 1px dashed rgba(15, 23, 42, 0.12);
        padding-left: 0;
        padding-top: 12px;
      }
    }

    @page {
      size: 105mm 22mm;
      margin: 0;
    }

    @media print {
      body {
        padding: 0;
        background: #fff;
      }

      main {
        display: none;
      }

      #printArea {
        display: block;
        margin: 0;
      }

      #printArea .label-page {
        box-shadow: none;
        border-radius: 0;
      }

      #printArea .label-page::after {
        display: none;
      }
    }
  </style>
</head>

<body>
  <main>
    <header class="card page-header">
      <div>
        <h1>In tem - Cô Mập Fashion</h1>
      </div>
      <div class="tab-nav" role="tablist">
        <button class="tab-button" id="tab-trigger-labels" type="button" role="tab" aria-controls="tab-labels" aria-selected="true"
          data-tab-target="labels">In tem</button>
        <button class="tab-button" id="tab-trigger-hasize" type="button" role="tab" aria-controls="tab-hasize" aria-selected="false"
          data-tab-target="hasize">Hạ size</button>
      </div>
    </header>

    <section class="tab-panel" data-tab-panel="labels" id="tab-labels">
      <section class="card">
        <h2>Nhập dòng hàng</h2>
        <div class="input-grid">
          <div>
            <label for="codeInput">Mã</label>
            <input type="text" id="codeInput" placeholder="Ví dụ: A123" autocomplete="off">
          </div>
          <div>
            <label for="sizeInput">Size</label>
            <select id="sizeInput">
              <option value="">Chọn size</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
              <option value="XXL">XXL</option>
              <option value="XXXL">XXXL</option>
            </select>
          </div>
          <div>
            <label for="qtyInput">Số lượng</label>
            <input type="number" id="qtyInput" placeholder=">= 1" min="1">
          </div>
        </div>
        <div class="actions">
          <button class="btn-primary" id="addItemBtn">Thêm dòng</button>
          <button class="btn-outline" id="resetBtn" type="button">Reset</button>
        </div>
        <div id="formMessage" class="status-line info" role="status">Nhập thông tin &amp; nhấn “Thêm dòng”.</div>
      </section>

      <section class="card">
        <div class="table-summary">
          <span id="itemCounter">0 dòng</span>
          <span id="qtyCounter">0 tem</span>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Mã</th>
                <th>Size</th>
                <th>Số lượng</th>
                <th>Ghi chú</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="itemsBody">
              <tr>
                <td colspan="6" class="empty-state">Chưa có dòng nào được thêm.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="actions single-action">
          <button class="btn-primary" id="sendWebhookBtn" disabled>Gửi</button>
        </div>
        <div id="statusBox" class="status-line info">Nhấn “Gửi” sau khi thêm đầy đủ dòng.</div>
      </section>

      <section class="card">
        <div class="layout-header">
          <div>
            <h2>Bản dàn tem</h2>
          </div>
          <button class="btn-outline" id="printBtn" type="button" style="display: none;" disabled>In</button>
        </div>
        <div id="layoutPreview" class="layout-grid">
          <div class="empty-state">Hãy nhấn “Gửi” để nhận tem.</div>
        </div>
      </section>
    </section>

    <section class="tab-panel" data-tab-panel="hasize" id="tab-hasize" hidden>
      <section class="card">
        <div class="layout-header">
          <div>
            <h2>Hạ size nhanh</h2>
          </div>
          <div class="hasize-actions">
            <button class="btn-outline" id="hasizePrintBtn" type="button" style="display: none;" disabled>In</button>
            <button class="btn-outline" id="hasizeClearBtn" type="button">Xóa danh sách</button>
          </div>
        </div>
        <div class="hasize-form">
          <div>
            <label for="hasizeInput">Serial / mã QR</label>
            <input type="text" id="hasizeInput" placeholder="Quét hoặc nhập serial" autocomplete="off">
          </div>
          <button class="btn-primary" id="hasizeSubmitBtn" type="button">Tạo QR hạ size</button>
        </div>
        <div id="hasizeStatus" class="status-line info" role="status">Quét sản phẩm cần hạ để nhận QR mới.</div>
      </section>
      <section class="card">
        <div class="table-summary">
          <span id="hasizeCounter">0 QR hạ size</span>
        </div>
        <div id="hasizeResults" class="hasize-grid">
          <div class="empty-state">Chưa có QR hạ size nào.</div>
        </div>
      </section>
    </section>

  </main>

  <!-- Vùng chỉ dùng cho in -->
  <section id="printArea" aria-hidden="true"></section>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const WEBHOOK_URL = 'https://n8n-hongnhung198198-u40833.vm.elestio.app/webhook/import-items';
      const HASIZE_WEBHOOK_URL = 'https://n8n-hongnhung198198-u40833.vm.elestio.app/webhook/hasize_hang';
      const CODE_REGEX = /^[ANT]\d{3}$/i;
      const ALLOWED_SIZES = ['M', 'L', 'XL', 'XXL', 'XXXL'];

      const state = {
        items: [],
        hashes: [],
        layoutReady: false,
        loading: false
      };

      const hasizeState = {
        entries: [],
        loading: false
      };
      let labelPrintHTML = '';

      const els = {
        code: document.getElementById('codeInput'),
        size: document.getElementById('sizeInput'),
        qty: document.getElementById('qtyInput'),
        addBtn: document.getElementById('addItemBtn'),
        resetBtn: document.getElementById('resetBtn'),
        formMessage: document.getElementById('formMessage'),
        itemCounter: document.getElementById('itemCounter'),
        qtyCounter: document.getElementById('qtyCounter'),
        body: document.getElementById('itemsBody'),
        sendBtn: document.getElementById('sendWebhookBtn'),
        printBtn: document.getElementById('printBtn'),
        statusBox: document.getElementById('statusBox'),
        layoutPreview: document.getElementById('layoutPreview'),
        printArea: document.getElementById('printArea'),
        tabButtons: document.querySelectorAll('[data-tab-target]'),
        tabPanels: document.querySelectorAll('[data-tab-panel]'),
        hasizeInput: document.getElementById('hasizeInput'),
        hasizeSubmit: document.getElementById('hasizeSubmitBtn'),
        hasizeClear: document.getElementById('hasizeClearBtn'),
        hasizePrintBtn: document.getElementById('hasizePrintBtn'),
        hasizeStatus: document.getElementById('hasizeStatus'),
        hasizeCounter: document.getElementById('hasizeCounter'),
        hasizeResults: document.getElementById('hasizeResults')
      };

      const hasizeSubmitLabel = els.hasizeSubmit?.textContent || 'Tạo QR hạ size';
      const DEFAULT_TAB = 'labels';

      const renderTable = () => {
        if (!state.items.length) {
          els.body.innerHTML = '<tr><td colspan="6" class="empty-state">Chưa có dòng nào được thêm.</td></tr>';
          renderTotals();
          return;
        }

        const rows = state.items.map((item, index) => {
          const note = item.error ? `<span style="color: var(--danger);">${item.error}</span>` : '—';
          return `
            <tr data-id="${item.id}" class="${item.error ? 'has-error' : ''}">
              <td>${index + 1}</td>
              <td>${item.code}</td>
              <td>${item.size}</td>
              <td>${item.qty}</td>
              <td>${note}</td>
              <td>
                <button class="btn-outline" data-remove="${item.id}" title="Xóa dòng">Xóa</button>
              </td>
            </tr>
          `;
        }).join('');
        els.body.innerHTML = rows;
        renderTotals();
      };

      const renderTotals = () => {
        els.itemCounter.textContent = `${state.items.length} dòng`;
        const qtyTotal = state.items.reduce((sum, i) => sum + i.qty, 0);
        els.qtyCounter.textContent = `${qtyTotal} tem`;
      };

      const setStatus = (type, message) => {
        els.statusBox.textContent = message;
        els.statusBox.className = `status-line ${type}`;
      };

      const setFormMessage = (type, message) => {
        els.formMessage.textContent = message;
        els.formMessage.className = `status-line ${type}`;
      };

      const setHasizeStatus = (type, message) => {
        if (!els.hasizeStatus) return;
        els.hasizeStatus.textContent = message;
        els.hasizeStatus.className = `status-line ${type}`;
      };

      const updateButtons = () => {
        const hasItems = state.items.length > 0;
        els.sendBtn.disabled = !hasItems || state.loading;
      };

      const updateHasizePrintButton = () => {
        if (!els.hasizePrintBtn) return;
        if (!hasizeState.entries.length) {
          els.hasizePrintBtn.style.display = 'none';
          els.hasizePrintBtn.disabled = true;
          return;
        }
        els.hasizePrintBtn.style.display = '';
        els.hasizePrintBtn.disabled = hasizeState.loading;
      };

      const updateHasizeControls = () => {
        if (els.hasizeSubmit) {
          els.hasizeSubmit.disabled = hasizeState.loading;
          els.hasizeSubmit.textContent = hasizeState.loading ? 'Đang tạo...' : hasizeSubmitLabel;
        }
        if (els.hasizeClear) {
          const disableClear = hasizeState.loading || hasizeState.entries.length === 0;
          els.hasizeClear.disabled = disableClear;
        }
        updateHasizePrintButton();
      };

      const activateTab = (tabName = DEFAULT_TAB) => {
        if (els.tabButtons?.forEach) {
          els.tabButtons.forEach((button) => {
            const isActive = button.dataset.tabTarget === tabName;
            button.setAttribute('aria-selected', String(isActive));
            button.classList.toggle('is-active', isActive);
          });
        }
        if (els.tabPanels?.forEach) {
          els.tabPanels.forEach((panel) => {
            const isActive = panel.dataset.tabPanel === tabName;
            if (isActive) {
              panel.removeAttribute('hidden');
            } else {
              panel.setAttribute('hidden', '');
            }
          });
        }
        if (tabName === 'hasize') {
          requestAnimationFrame(() => {
            els.hasizeInput?.focus();
          });
        }
      };

      const showPrintButton = () => {
        els.printBtn.style.display = '';
        els.printBtn.disabled = false;
      };

      const hidePrintButton = () => {
        els.printBtn.style.display = 'none';
        els.printBtn.disabled = true;
      };

      const resetAll = () => {
        state.items = [];
        state.hashes = [];
        state.layoutReady = false;
        state.loading = false;
        renderTable();
        els.layoutPreview.innerHTML = '<div class="empty-state">Chưa có dữ liệu hashes. Hãy nhấn “Gửi” để nhận tem.</div>';
        els.printArea.innerHTML = '';
        labelPrintHTML = '';
        hidePrintButton();
        resetForm();
        setStatus('info', 'Đã reset toàn bộ dữ liệu.');
        setFormMessage('info', 'Nhập thông tin & nhấn “Thêm dòng”.');
        updateButtons();
      };

      const sanitizeCode = (value) => value.trim().toUpperCase();
      const sanitizeSize = (value) => value.trim().toUpperCase();
      const sanitizeQty = (value) => Number.parseInt(value, 10) || 0;
      const sanitizeSerial = (value) => value.trim().toUpperCase();

      const validateItem = ({ code, size, qty }) => {
        if (!code) return 'Vui lòng nhập mã.';
        if (!CODE_REGEX.test(code)) return 'Mã phải bắt đầu bằng A/N/T + 3 số (ví dụ A123).';
        if (!size) return 'Chọn size.';
        if (!ALLOWED_SIZES.includes(size)) return 'Size chỉ nhận M, L, XL, XXL, XXXL.';
        if (!Number.isInteger(qty) || qty < 1) return 'Số lượng phải là số nguyên ≥ 1.';
        return '';
      };

      const resetForm = () => {
        els.code.value = '';
        els.size.value = '';
        els.qty.value = '';
        els.code.focus();
      };

      const addItem = () => {
        const code = sanitizeCode(els.code.value);
        const size = sanitizeSize(els.size.value);
        const qty = sanitizeQty(els.qty.value);
        const validation = validateItem({ code, size, qty });

        if (validation) {
          setFormMessage('error', validation);
          return;
        }

        state.items.push({
          id: cryptoId(),
          code,
          size,
          qty,
          error: ''
        });

        setFormMessage('success', 'Đã thêm vào bảng tạm.');
        renderTable();
        updateButtons();
        resetForm();
      };

      const removeItem = (id) => {
        state.items = state.items.filter((item) => item.id !== id);
        renderTable();
        updateButtons();
      };

      const validateAllRows = () => {
        let hasError = false;
        state.items = state.items.map((item) => {
          const error = validateItem(item);
          if (error) hasError = true;
          return { ...item, error };
        });
        renderTable();
        return !hasError;
      };

      const buildQrUrl = (value) =>
        `https://quickchart.io/qr?size=200&text=${encodeURIComponent(value)}`;

      const cryptoId = () => {
        if (window.crypto?.randomUUID) return window.crypto.randomUUID();
        return `id-${Date.now()}-${Math.random().toString(16).slice(2)}`;
      };

      const formatDateTime = (value) => {
        if (!value) return '—';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return value;
        return date.toLocaleString('vi-VN');
      };

      const normalizeHasizeItem = (item, fallbackSerial) => {
        if (!item && !fallbackSerial) return null;
        const serial = sanitizeSerial(item?.serial || fallbackSerial || '');
        if (!serial) return null;
        return {
          id: item?.id || cryptoId(),
          sku: sanitizeCode(item?.sku || ''),
          size: sanitizeSize(item?.size || ''),
          serial,
          status: item?.status || '',
          orderCode: item?.order_code || '',
          createdAt: item?.created_at || new Date().toISOString(),
          hash: item?.hash || ''
        };
      };

      const getHasizeQrValue = (entry) => entry.serial || [entry.sku, entry.size, entry.hash].filter(Boolean).join('-');

      const buildHasizeCardHtml = (entry, options = {}) => {
        const { lazy = true } = options;
        const qrValue = getHasizeQrValue(entry);
        const sku = entry.sku || '—';
        const sizeText = entry.size || '—';
        const metaParts = [`SKU: ${sku}`, `Size: ${sizeText}`];
        const metaHtml = metaParts.map((text) => `<span>${text}</span>`).join('');
        const loadingAttr = lazy ? ' loading="lazy"' : '';
        return `
            <article class="hasize-card">
              <div class="hasize-details">
                <div class="hasize-meta">${metaHtml}</div>
              </div>
              <div class="hasize-qr">
                <img src="${buildQrUrl(qrValue)}" alt="QR hạ size" ${loadingAttr}>
                <span>Quét để hạ size</span>
              </div>
            </article>
          `;
      };

      const upsertHasizeEntries = (entries) => {
        entries.forEach((entry) => {
          const index = hasizeState.entries.findIndex((item) => item.serial === entry.serial);
          if (index >= 0) {
            hasizeState.entries[index] = entry;
          } else {
            hasizeState.entries.unshift(entry);
          }
        });
      };

      const renderHasizeResults = () => {
        if (!els.hasizeResults) return;
        if (els.hasizeCounter) {
          els.hasizeCounter.textContent = `${hasizeState.entries.length} QR hạ size`;
        }
        if (!hasizeState.entries.length) {
          els.hasizeResults.innerHTML = '<div class="empty-state">Chưa có QR hạ size nào.</div>';
          updateHasizePrintButton();
          return;
        }

        const cards = hasizeState.entries.map((entry) => buildHasizeCardHtml(entry)).join('');

        els.hasizeResults.innerHTML = cards;
        updateHasizePrintButton();
      };

      const clearHasizeResults = () => {
        hasizeState.entries = [];
        renderHasizeResults();
        setHasizeStatus('info', 'Đã xóa danh sách QR hạ size.');
        updateHasizeControls();
      };

      const chunkLabels = (labels) => {
        const pages = [];
        for (let i = 0; i < labels.length; i += 3) {
          pages.push(labels.slice(i, i + 3));
        }
        if (pages.length) {
          const lastPage = pages[pages.length - 1];
          while (lastPage.length < 3) {
            lastPage.push({ blank: true });
          }
        }
        return pages;
      };

      const buildHasizePrintLayout = () => {
        if (!hasizeState.entries.length) return '';
        const labels = hasizeState.entries.map((entry) => ({
          code: entry.sku || '—',
          size: entry.size || '',
          value: getHasizeQrValue(entry)
        }));
        const pages = chunkLabels(labels);
        if (!pages.length) return '';
        return pages.map((labelsOnPage, pageIndex) => {
          const cells = labelsOnPage.map((label) => {
            if (label.blank) {
              return '<div class="label-cell is-blank"><span>Tem trống</span></div>';
            }
            const sku = label.code || '—';
            const sizeText = label.size || '';
            const qrValue = label.value || '';
            return `
              <div class="label-cell">
                <div class="label-qr" data-qr="${qrValue}">
                  <img alt="QR ${qrValue}">
                  <span class="qr-fallback">QR lỗi</span>
                </div>
                <div class="label-text">
                  <span class="code">${sku}</span>
                  <span class="size">${sizeText}</span>
                </div>
              </div>
            `;
          }).join('');
          return `<div class="label-page" data-page="Trang ${pageIndex + 1}">${cells}</div>`;
        }).join('');
      };

      const restoreLabelPrintArea = () => {
        if (state.layoutReady && labelPrintHTML) {
          els.printArea.innerHTML = labelPrintHTML;
          return;
        }
        if (!state.layoutReady) {
          els.printArea.innerHTML = '';
        }
      };

      const handleHasizePrint = () => {
        if (!hasizeState.entries.length) {
          setHasizeStatus('error', 'Chưa có QR hạ size để in.');
          return;
        }

        const layout = buildHasizePrintLayout();
        if (!layout) {
          setHasizeStatus('error', 'Chưa có QR hạ size để in.');
          return;
        }

        setHasizeStatus('info', 'Đang mở hộp thoại in QR hạ size...');
        els.printArea.innerHTML = layout;
        let cleanedUp = false;
        renderQrCodes(els.printArea);
        const cleanup = () => {
          if (cleanedUp) return;
          cleanedUp = true;
          restoreLabelPrintArea();
          setHasizeStatus('success', 'Đã chuẩn bị xong bản in QR hạ size.');
          window.removeEventListener('afterprint', cleanup);
          window.removeEventListener('focus', cleanup);
        };
        window.addEventListener('afterprint', cleanup);
        window.addEventListener('focus', cleanup);
        window.print();
      };

      const handleHasizeSubmit = async () => {
        const serial = sanitizeSerial(els.hasizeInput?.value || '');
        if (!serial) {
          setHasizeStatus('error', 'Vui lòng quét hoặc nhập serial.');
          els.hasizeInput?.focus();
          return;
        }

        hasizeState.loading = true;
        updateHasizeControls();
        setHasizeStatus('info', 'Đang tạo QR hạ size...');

        try {
          const response = await fetch(HASIZE_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ serial })
          });

          if (!response.ok) {
            const text = await response.text();
            throw new Error(text || `Webhook trả về mã lỗi ${response.status}`);
          }

          const payload = await response.json();
          const list = Array.isArray(payload) ? payload : [payload];
          const normalized = list.map((item) => normalizeHasizeItem(item, serial)).filter(Boolean);

          if (!normalized.length) {
            throw new Error('Webhook không trả về thông tin serial hợp lệ.');
          }

          upsertHasizeEntries(normalized);
          renderHasizeResults();
          setHasizeStatus('success', `Đã tạo ${normalized.length} QR hạ size.`);
          if (els.hasizeInput) {
            els.hasizeInput.value = '';
            els.hasizeInput.focus();
          }
        } catch (error) {
          console.error(error);
          setHasizeStatus('error', error.message || 'Không tạo được QR hạ size.');
        } finally {
          hasizeState.loading = false;
          updateHasizeControls();
        }
      };

      const extractSerials = (payload) => {
        if (!payload) return [];
        const strings = [];
        const collect = (value) => {
          if (Array.isArray(value)) {
            value.forEach((entry) => {
              if (typeof entry === 'string') {
                strings.push(entry);
              } else if (entry && typeof entry === 'object') {
                collect(entry.serials);
                collect(entry.hashes);
              }
            });
          } else if (typeof value === 'string') {
            strings.push(value);
          } else if (value && typeof value === 'object') {
            collect(value.serials);
            collect(value.hashes);
          }
        };
        collect(payload);
        return strings.filter(Boolean);
      };

      const sendWebhook = async () => {
        if (!validateAllRows()) {
          setStatus('error', 'Có dòng chưa hợp lệ, vui lòng kiểm tra lại.');
          return;
        }
        const payloadItems = state.items.map(({ code, size, qty }) => ({ code, size, qty }));
        const hadLayoutBeforeSend = state.layoutReady;
        state.layoutReady = false;
        hidePrintButton();
        state.loading = true;
        updateButtons();
        setStatus('info', 'Đang gửi webhook...');
        try {
          const res = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: payloadItems })
          });

          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || `Webhook trả về mã lỗi ${res.status}`);
          }

          const data = await res.json();
          const hashes = extractSerials(data);
          if (!hashes.length) {
            throw new Error('Webhook không trả về danh sách serials/hashes hợp lệ.');
          }

          state.hashes = hashes;
          buildLayout();
        } catch (error) {
          console.error(error);
          setStatus('error', error.message || 'Gửi webhook thất bại.');
          if (hadLayoutBeforeSend && state.hashes.length) {
            state.layoutReady = true;
            showPrintButton();
          }
        } finally {
          state.loading = false;
          updateButtons();
        }
      };

      const parseHashes = () => {
        const normalized = [];
        state.hashes.forEach((entry) => {
          if (typeof entry !== 'string') return;
          const parts = entry.split('-');
          const code = (parts.shift() || '').toUpperCase();
          const size = (parts.shift() || '').toUpperCase();
          const hash = (parts.join('-') || '').toUpperCase();
          if (!code || !size) return;
          const qrValue = hash ? `${code}-${size}-${hash}` : `${code}-${size}`;
          normalized.push({ code, size, hash, value: qrValue });
        });
        return normalized;
      };

      const renderPages = (container, pages) => {
        if (!pages.length) {
          container.innerHTML = '<div class="empty-state">Chưa có bản dàn tem.</div>';
          return;
        }

        const pageHtml = pages.map((labels, pageIndex) => {
          const cells = labels.map((label) => {
            if (label.blank) {
              return '<div class="label-cell is-blank"><span>Tem trống</span></div>';
            }
            return `
              <div class="label-cell">
                <div class="label-qr" data-qr="${label.value}">
                  <img alt="QR ${label.value}">
                  <span class="qr-fallback">QR lỗi</span>
                </div>
                <div class="label-text">
                  <span class="code">${label.code}</span>
                  <span class="size">${label.size}</span>
                </div>
              </div>
            `;
          }).join('');

          return `<div class="label-page" data-page="Trang ${pageIndex + 1}">${cells}</div>`;
        }).join('');

        container.innerHTML = pageHtml;
        renderQrCodes(container);
        if (container === els.printArea) {
          labelPrintHTML = container.innerHTML;
        }
      };

      const renderQrCodes = (container) => {
        const targets = container.querySelectorAll('.label-qr[data-qr]');
        targets.forEach((node) => {
          const value = node.dataset.qr;
          const img = node.querySelector('img');
          if (!value || !img) return;
          node.classList.remove('qr-missing');
          img.src = buildQrUrl(value);
          img.alt = `QR ${value}`;
          img.onload = () => {
            node.classList.remove('qr-missing');
          };
          img.onerror = () => {
            node.classList.add('qr-missing');
          };
        });
      };

      const buildLayout = () => {
        if (!state.hashes.length) {
          setStatus('error', 'Chưa có dữ liệu hashes. Hãy nhấn “Gửi” trước.');
          return;
        }

        const labels = parseHashes();
        const pages = chunkLabels(labels);
        renderPages(els.layoutPreview, pages);
        renderPages(els.printArea, pages);
        state.layoutReady = true;
        showPrintButton();
        setStatus('success', `Đã dàn ${labels.length} tem thành ${pages.length} trang.`);
      };

      const handlePrint = () => {
        if (!state.layoutReady) {
          setStatus('error', 'Chưa có bản dàn tem để in.');
          return;
        }
        window.print();
      };

      els.addBtn.addEventListener('click', addItem);
      els.resetBtn.addEventListener('click', resetAll);
      els.sendBtn.addEventListener('click', sendWebhook);
      els.printBtn.addEventListener('click', handlePrint);

      els.body.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-remove]');
        if (button) {
          removeItem(button.getAttribute('data-remove'));
        }
      });

      ['code', 'size', 'qty'].forEach((key) => {
        const input = els[key];
        input.addEventListener('keydown', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            addItem();
          }
        });
      });

      els.hasizeSubmit?.addEventListener('click', handleHasizeSubmit);
      els.hasizeInput?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          handleHasizeSubmit();
        }
      });
      els.hasizeClear?.addEventListener('click', clearHasizeResults);
      els.hasizePrintBtn?.addEventListener('click', handleHasizePrint);

      if (els.tabButtons?.forEach) {
        els.tabButtons.forEach((button) => {
          button.addEventListener('click', () => {
            activateTab(button.dataset.tabTarget);
          });
        });
      }

      activateTab(DEFAULT_TAB);
      hidePrintButton();
      updateButtons();
      renderHasizeResults();
      updateHasizeControls();
    });
  </script>
</body>

</html>
