<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nh·∫≠p H√†ng - C√¥ M·∫≠p Fashion</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#f5d7fa" />
  <style>
    :root{
      --fix-scale-x: 1.00; /* gi·ªØ nguy√™n 1:1 v√¨ nh√£n gi·ªù vu√¥ng */
    }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: linear-gradient(to right, #fdfbfb, #ebedee);
      max-width: 600px;
      margin: 0 auto;
    }
    h2 { color: #d147a3; }
    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button { background:#d147a3; color:#fff; font-weight:bold; cursor:pointer; }
    button:hover { opacity:.9; }
    #preview {
      margin-top: 20px; border:1px solid #ddd; padding:15px; display:none;
      background:#fff; border-radius:8px;
    }
    iframe {
      width: 100%; height: 800px; border:1px solid #eee; margin-top:10px;
      transform: scaleX(var(--fix-scale-x));
      transform-origin: top left;
    }
    .action-buttons { display:flex; gap:10px; margin-bottom:10px; }
    .action-buttons button { flex:1; padding:10px; border-radius:6px; }
    .print-button { background:#4CAF50 !important; }
    .pdf-button   { background:#2196F3 !important; }

    /* In chu·∫©n 203dpi cho nh√£n 35x35mm */
    @media print {
      @page { size: 35mm 35mm; margin: 0; }

      html, body {
        width: 35mm;
        height: 35mm;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      body * { visibility: hidden !important; }
      #htmlPreview, #htmlPreview * { visibility: visible !important; }

      #htmlPreview {
        position: absolute !important;
        left: 0 !important;
        top: 0 !important;
        width: 35mm !important;
        height: 35mm !important;
        border: 0 !important;
        transform: scaleX(var(--fix-scale-x)) !important;
        transform-origin: top left !important;
      }

      iframe {
        width: 35mm !important;
        height: 35mm !important;
        border: 0 !important;
      }
    }
  </style>
</head>
<body>
  <h2>‚úÖ Nh·∫≠p h√†ng m·ªõi ‚Äì C√¥ M·∫≠p Fashion</h2>

  <input type="text" id="sku" placeholder="SKU (VD: A350)" value="A350" />
  <input type="text" id="size" placeholder="Size (VD: XL)" value="XL" />
  <input type="number" id="qty" placeholder="S·ªë l∆∞·ª£ng" value="15" min="1" />
  <input type="text" id="staff" placeholder="Nh√¢n vi√™n" value="Linh" />
  <button onclick="submitImport()">üì§ G·ª≠i nh·∫≠p h√†ng</button>

  <div id="preview">
    <h3>üìé Xem tr∆∞·ªõc QR:</h3>
    <div class="action-buttons">
      <button class="print-button" onclick="printQR()">üñ®Ô∏è In QR</button>
      <button class="pdf-button" onclick="downloadPDF()">üíæ T·∫£i PDF</button>
    </div>
    <iframe id="htmlPreview"></iframe>
  </div>

  <script>
    const scaleKey = 'label_scaleX';
    function setScaleX(v){
      const val = Math.max(0.90, Math.min(1.20, Number(v) || 1));
      document.documentElement.style.setProperty('--fix-scale-x', String(val));
      localStorage.setItem(scaleKey, String(val));
    }
    setScaleX(localStorage.getItem(scaleKey) || 1.00);

    async function submitImport() {
      const sku   = document.getElementById("sku").value.trim();
      const size  = document.getElementById("size").value.trim();
      const qty   = parseInt(document.getElementById("qty").value);
      const staff = document.getElementById("staff").value.trim();
      if (!sku || !size || !qty || !staff) {
        alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
      }
      const payload = { sku, size, qty, staff };

      try {
        const res = await fetch("https://n8n-hongnhung198198-u40833.vm.elestio.app/webhook/import-items", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        let data;
        try { data = await res.json(); }
        catch (e) { throw new Error(`Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON: ${ (await res.text()).substring(0,200) }`); }

        let htmlUrl;
        if (Array.isArray(data) && data[0]?.url) htmlUrl = data[0].url;
        else if (data && typeof data === 'object' && data.url) htmlUrl = data.url;
        if (!htmlUrl) throw new Error("Ph·∫£n h·ªìi kh√¥ng ch·ª©a URL h·ª£p l·ªá");
        if (!htmlUrl.startsWith("data:text/html;base64,")) throw new Error("URL kh√¥ng ph·∫£i d·ªØ li·ªáu base64 HTML");

        const base64Html = htmlUrl.split(",")[1];
        const htmlContent = atob(base64Html);
        const blob = new Blob([htmlContent], { type: "text/html" });
        const url  = URL.createObjectURL(blob);
        document.getElementById("preview").style.display = "block";
        document.getElementById("htmlPreview").src = url;
      } catch (err) {
        console.error("L·ªói webhook:", err);
        alert(`‚ùå L·ªói: ${err.message}`);
      }
    }

    function printQR() {
      const iframe = document.getElementById("htmlPreview");
      if (iframe && iframe.contentWindow) {
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
      } else {
        alert("Kh√¥ng th·ªÉ in. Vui l√≤ng th·ª≠ l·∫°i.");
      }
    }

    function downloadPDF() {
      const iframe = document.getElementById("htmlPreview");
      if (!iframe || !iframe.contentWindow || !iframe.contentDocument) {
        alert("Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ t·∫£i. Vui l√≤ng ch·ªù t·∫£i xong.");
        return;
      }
      const htmlContent = iframe.contentDocument.documentElement.outerHTML;
      const blob = new Blob([htmlContent], { type: "text/html" });
      const url  = URL.createObjectURL(blob);
      const win  = window.open(url, '_blank');
      if (win) win.onload = () => { win.focus(); setTimeout(() => win.print(), 500); };
      else alert("Vui l√≤ng cho ph√©p pop-up ƒë·ªÉ t·∫£i PDF.");
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(console.warn);
      });
    }
  </script>
</body>
</html>
